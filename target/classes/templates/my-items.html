<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="layout/base :: head"></head>
<body>
<div>
    <div th:replace="layout/base :: navbar"></div>
    <main class="main-content">
    <div class="container py-4">
        <h2 class="mb-4">我的失物/拾物</h2>
        
        <!-- 成功消息 -->
        <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            <span th:if="${param.success[0] == 'completed'}">物品已标记为完成</span>
            <span th:if="${param.success[0] == 'deleted'}">物品删除成功</span>
            <span th:if="${param.success[0] == 'updated'}">物品更新成功</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- 错误消息 -->
        <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:if="${param.error[0] == 'completion_failed'}">确认完成失败，请重试</span>
            <span th:if="${param.error[0] == 'delete_failed'}">删除失败，请重试</span>
            <span th:if="${param.error[0] == 'update_failed'}">更新失败，请重试</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- 标签页导航 -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link fw-bold" 
                   th:classappend="${currentTab == 'active'} ? 'active bg-primary text-white' : 'text-primary'"
                   th:href="@{/items/my-items(tab=active)}"
                   style="border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                    <i class="bi bi-collection me-1"></i>进行中的物品
                    <span class="badge ms-1" 
                          th:classappend="${currentTab == 'active'} ? 'bg-light text-primary' : 'bg-primary text-white'"
                          th:text="${#lists.size(activeItems)}">0</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link fw-bold" 
                   th:classappend="${currentTab == 'completed'} ? 'active bg-success text-white' : 'text-success'"
                   th:href="@{/items/my-items(tab=completed)}"
                   style="border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                    <i class="bi bi-check-circle me-1"></i>已完成
                    <span class="badge ms-1" 
                          th:classappend="${currentTab == 'completed'} ? 'bg-light text-success' : 'bg-success text-white'"
                          th:text="${#lists.size(completedItems)}">0</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link fw-bold" 
                   th:classappend="${currentTab == 'claims'} ? 'active bg-warning text-white' : 'text-warning'"
                   th:href="@{/items/my-items(tab=claims)}"
                   style="border-radius: 8px 8px 0 0; transition: all 0.3s ease;">
                    <i class="bi bi-hand-thumbs-up me-1"></i>我的认领
                    <span class="badge ms-1" 
                          th:classappend="${currentTab == 'claims'} ? 'bg-light text-warning' : 'bg-warning text-white'"
                          th:text="${claimedItems != null ? #lists.size(claimedItems) : 0}">0</span>
                </a>
            </li>
        </ul>
        
        <!-- 进行中的物品 -->
        <div th:if="${currentTab == 'active'}">
            <!-- 失物和拾获子标签 -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="activeSubTab" id="activeLost" autocomplete="off" checked>
                        <label class="btn btn-danger fw-bold text-black" for="activeLost">
                            <i class="bi bi-search me-1"></i>失物 
                            <span class="badge bg-white text-danger ms-1" th:text="${#lists.size(activeLostItems)}">0</span>
                        </label>
                        
                        <input type="radio" class="btn-check" name="activeSubTab" id="activeFound" autocomplete="off">
                        <label class="btn btn-outline-success fw-bold bg-light text-black" for="activeFound">
                            <i class="bi bi-hand-thumbs-up me-1"></i>拾获 
                            <span class="badge bg-success ms-1" th:text="${#lists.size(activeFoundItems)}">0</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 失物内容 -->
            <div id="activeLostContent">
                <div class="row g-3" th:if="${activeLostItems != null and !#lists.isEmpty(activeLostItems)}">
                    <div class="col-md-4" th:each="it : ${activeLostItems}">
                        <div class="card h-100 shadow-sm border-danger">
                            <div class="card-body">
                                <h5 class="card-title text-danger" th:text="${it.title}">标题</h5>
                                <p class="card-text text-truncate-3" th:text="${it.description}">描述</p>
                                <div class="small text-muted mb-2">
                                    <span class="badge bg-danger me-1" th:text="${it.postType.getDescription()}">失物</span>
                                    <span th:text="${it.category.getDescription()}">类别</span>
                                    · 审核：<span th:text="${it.approved} ? '通过' : '待审'"></span>
                                </div>
                                <div class="mb-2">
                                    <span th:if="${it.status.name() == 'PENDING_APPROVAL'}" class="badge bg-warning" th:text="${it.status.getDescription()}">待审核</span>
                                    <span th:if="${it.status.name() == 'PENDING_CLAIM'}" class="badge bg-info" th:text="${it.status.getDescription()}">待认领</span>
                                    <span th:if="${it.status.name() == 'CLAIMED'}" class="badge bg-success" th:text="${it.status.getDescription()}">已认领</span>
                                    <span th:if="${it.status.name() == 'UNCLAIMED'}" class="badge bg-secondary" th:text="${it.status.getDescription()}">无人认领</span>
                                    <span th:if="${it.status.name() == 'EXPIRED'}" class="badge bg-danger" th:text="${it.status.getDescription()}">已过期</span>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 d-flex gap-2">
                                <a class="btn btn-outline-primary btn-sm" th:href="@{'/items/' + ${it.id}}">查看详情</a>
                                <form th:action="@{'/items/' + ${it.id} + '/confirm-completion'}" method="post"
                                      th:if="${it.approved && it.status.name() != 'COMPLETED' && it.status.name() != 'PENDING_APPROVAL'}"
                                      onsubmit="return confirm('确认将此物品标记为已完成？完成后将无法继续聊天。');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-success btn-sm">确认完成</button>
                                </form>
                                <form th:action="@{'/items/' + ${it.id} + '/delete'}" method="post"
                                      onsubmit="return confirm('确定删除这条记录吗？');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-danger btn-sm">删除</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 无失物时的提示 -->
                <div th:if="${activeLostItems == null or #lists.isEmpty(activeLostItems)}" class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">暂无进行中的失物</h4>
                    <p class="text-muted">您可以发布新的失物信息</p>
                    <a class="btn btn-danger" th:href="@{/items/post}">
                        <i class="bi bi-plus-circle me-1"></i>发布失物
                    </a>
                </div>
            </div>
            
            <!-- 拾获内容 -->
            <div id="activeFoundContent" style="display: none;">
                <div class="row g-3" th:if="${activeFoundItems != null and !#lists.isEmpty(activeFoundItems)}">
                    <div class="col-md-4" th:each="it : ${activeFoundItems}">
                        <div class="card h-100 shadow-sm border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success" th:text="${it.title}">标题</h5>
                                <p class="card-text text-truncate-3" th:text="${it.description}">描述</p>
                                <div class="small text-muted mb-2">
                                    <span class="badge bg-success me-1" th:text="${it.postType.getDescription()}">拾获</span>
                                    <span th:text="${it.category.getDescription()}">类别</span>
                                    · 审核：<span th:text="${it.approved} ? '通过' : '待审'"></span>
                                </div>
                                <div class="mb-2">
                                    <span th:if="${it.status.name() == 'PENDING_APPROVAL'}" class="badge bg-warning" th:text="${it.status.getDescription()}">待审核</span>
                                    <span th:if="${it.status.name() == 'PENDING_CLAIM'}" class="badge bg-info" th:text="${it.status.getDescription()}">待认领</span>
                                    <span th:if="${it.status.name() == 'CLAIMED'}" class="badge bg-success" th:text="${it.status.getDescription()}">已认领</span>
                                    <span th:if="${it.status.name() == 'UNCLAIMED'}" class="badge bg-secondary" th:text="${it.status.getDescription()}">无人认领</span>
                                    <span th:if="${it.status.name() == 'EXPIRED'}" class="badge bg-danger" th:text="${it.status.getDescription()}">已过期</span>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 d-flex gap-2">
                                <a class="btn btn-outline-primary btn-sm" th:href="@{'/items/' + ${it.id}}">查看详情</a>
                                <form th:action="@{'/items/' + ${it.id} + '/confirm-completion'}" method="post"
                                      th:if="${it.approved && it.status.name() != 'COMPLETED' && it.status.name() != 'PENDING_APPROVAL'}"
                                      onsubmit="return confirm('确认将此物品标记为已完成？完成后将无法继续聊天。');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-success btn-sm">确认完成</button>
                                </form>
                                <form th:action="@{'/items/' + ${it.id} + '/delete'}" method="post"
                                      onsubmit="return confirm('确定删除这条记录吗？');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-danger btn-sm">删除</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 无拾获时的提示 -->
                <div th:if="${activeFoundItems == null or #lists.isEmpty(activeFoundItems)}" class="text-center py-5">
                    <i class="bi bi-hand-thumbs-up display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">暂无进行中的拾获</h4>
                    <p class="text-muted">您可以发布新的拾获信息</p>
                    <a class="btn btn-success" th:href="@{/items/post}">
                        <i class="bi bi-plus-circle me-1"></i>发布拾获
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 已完成的物品 -->
        <div th:if="${currentTab == 'completed'}">
            <!-- 失物和拾获子标签 -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="completedSubTab" id="completedLost" autocomplete="off" checked>
                        <label class="btn btn-danger fw-bold text-black" for="completedLost">
                            <i class="bi bi-search me-1"></i>失物 
                            <span class="badge bg-white text-danger ms-1" th:text="${#lists.size(completedLostItems)}">0</span>
                        </label>
                        
                        <input type="radio" class="btn-check" name="completedSubTab" id="completedFound" autocomplete="off">
                        <label class="btn btn-outline-success fw-bold bg-light text-black" for="completedFound">
                            <i class="bi bi-hand-thumbs-up me-1"></i>拾获 
                            <span class="badge bg-success ms-1" th:text="${#lists.size(completedFoundItems)}">0</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 已完成失物内容 -->
            <div id="completedLostContent">
                <div class="row g-3" th:if="${completedLostItems != null and !#lists.isEmpty(completedLostItems)}">
                    <div class="col-md-4" th:each="it : ${completedLostItems}">
                        <div class="card h-100 shadow-sm border-danger">
                            <div class="card-body">
                                <h5 class="card-title text-danger" th:text="${it.title}">标题</h5>
                                <p class="card-text text-truncate-3" th:text="${it.description}">描述</p>
                                <div class="small text-muted mb-2">
                                    <span class="badge bg-danger me-1" th:text="${it.postType.getDescription()}">失物</span>
                                    <span th:text="${it.category.getDescription()}">类别</span>
                                    · 审核：<span th:text="${it.approved} ? '通过' : '待审'"></span>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-dark" th:text="${it.status.getDescription()}">已完成</span>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 d-flex gap-2">
                                <a class="btn btn-outline-primary btn-sm" th:href="@{'/items/' + ${it.id}}">查看详情</a>
                                <form th:action="@{'/items/' + ${it.id} + '/delete'}" method="post"
                                      onsubmit="return confirm('确定删除这条记录吗？');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-danger btn-sm">删除</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 无已完成失物时的提示 -->
                <div th:if="${completedLostItems == null or #lists.isEmpty(completedLostItems)}" class="text-center py-5">
                    <i class="bi bi-search display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">暂无已完成的失物</h4>
                    <p class="text-muted">完成的失物会显示在这里</p>
                </div>
            </div>
            
            <!-- 已完成拾获内容 -->
            <div id="completedFoundContent" style="display: none;">
                <div class="row g-3" th:if="${completedFoundItems != null and !#lists.isEmpty(completedFoundItems)}">
                    <div class="col-md-4" th:each="it : ${completedFoundItems}">
                        <div class="card h-100 shadow-sm border-success">
                            <div class="card-body">
                                <h5 class="card-title text-success" th:text="${it.title}">标题</h5>
                                <p class="card-text text-truncate-3" th:text="${it.description}">描述</p>
                                <div class="small text-muted mb-2">
                                    <span class="badge bg-success me-1" th:text="${it.postType.getDescription()}">拾获</span>
                                    <span th:text="${it.category.getDescription()}">类别</span>
                                    · 审核：<span th:text="${it.approved} ? '通过' : '待审'"></span>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-dark" th:text="${it.status.getDescription()}">已完成</span>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 d-flex gap-2">
                                <a class="btn btn-outline-primary btn-sm" th:href="@{'/items/' + ${it.id}}">查看详情</a>
                                <form th:action="@{'/items/' + ${it.id} + '/delete'}" method="post"
                                      onsubmit="return confirm('确定删除这条记录吗？');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button type="submit" class="btn btn-danger btn-sm">删除</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 无已完成拾获时的提示 -->
                <div th:if="${completedFoundItems == null or #lists.isEmpty(completedFoundItems)}" class="text-center py-5">
                    <i class="bi bi-hand-thumbs-up display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">暂无已完成的拾获</h4>
                    <p class="text-muted">完成的拾获会显示在这里</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 我的认领标签页内容 -->
    <div th:if="${currentTab == 'claims'}" class="tab-content">
        <div class="row">
            <div class="col-12 col-md-11 col-lg-10 mx-auto">
                <h4 class="mb-3 text-warning">
                    <i class="bi bi-hand-thumbs-up me-2"></i>我的认领
                    <small class="text-muted">（我成功认领的物品）</small>
                </h4>
                
                <!-- 认领物品列表 -->
                <div th:if="${claimedItems != null and !#lists.isEmpty(claimedItems)}" class="row">
                    <div class="col-md-6 col-lg-4 mb-4" th:each="item : ${claimedItems}">
                        <div class="card h-100 shadow-sm border-warning">
                            <div class="card-body">
                                <h5 class="card-title text-warning" th:text="${item.title}">标题</h5>
                                <p class="card-text text-truncate-3" th:text="${item.description}">描述</p>
                                <div class="small text-muted mb-2">
                                    <span class="badge bg-warning text-dark me-1" th:text="${item.postType.getDescription()}">拾获</span>
                                    <span th:text="${item.category.getDescription()}">类别</span>
                                    · 发布者：<span th:text="${item.owner.displayName}">发布者</span>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-success">已认领</span>
                                </div>
                                <div class="small text-muted">
                                    认领时间：<span th:text="${#temporals.format(item.updatedAt, 'yyyy-MM-dd HH:mm')}">时间</span>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-0 d-flex gap-2">
                                <a class="btn btn-outline-warning btn-sm" th:href="@{'/items/' + ${item.id}}">查看详情</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 无认领物品时的提示 -->
                <div th:if="${claimedItems == null or #lists.isEmpty(claimedItems)}" class="text-center py-5">
                    <i class="bi bi-hand-thumbs-up display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">暂无认领记录</h4>
                    <p class="text-muted">您成功认领的物品会显示在这里</p>
                    <a href="/" class="btn btn-warning">
                        <i class="bi bi-search me-1"></i>去寻找物品
                    </a>
                </div>
            </div>
        </div>
    </div>
    </main>
    <div th:replace="layout/base :: footer"></div>
</div>
</body>
</html>



<script>
// 等待DOM加载完成
document.addEventListener('DOMContentLoaded', function() {
    // 进行中物品的子标签切换
    const activeLost = document.getElementById('activeLost');
    const activeFound = document.getElementById('activeFound');
    const activeLostContent = document.getElementById('activeLostContent');
    const activeFoundContent = document.getElementById('activeFoundContent');
    
    if (activeLost && activeFound && activeLostContent && activeFoundContent) {
        activeLost.addEventListener('change', function() {
            if (this.checked) {
                activeLostContent.style.display = 'block';
                activeFoundContent.style.display = 'none';
            }
        });

        activeFound.addEventListener('change', function() {
            if (this.checked) {
                activeLostContent.style.display = 'none';
                activeFoundContent.style.display = 'block';
            }
        });
    }

    // 已完成物品的子标签切换
    const completedLost = document.getElementById('completedLost');
    const completedFound = document.getElementById('completedFound');
    const completedLostContent = document.getElementById('completedLostContent');
    const completedFoundContent = document.getElementById('completedFoundContent');
    
    if (completedLost && completedFound && completedLostContent && completedFoundContent) {
        completedLost.addEventListener('change', function() {
            if (this.checked) {
                completedLostContent.style.display = 'block';
                completedFoundContent.style.display = 'none';
            }
        });

        completedFound.addEventListener('change', function() {
            if (this.checked) {
                completedLostContent.style.display = 'none';
                completedFoundContent.style.display = 'block';
            }
        });
    }
});
</script>


